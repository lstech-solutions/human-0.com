name: Sync Translations

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      direction:
        description: "Sync direction"
        required: true
        default: "download"
        type: choice
        options:
          - download
          - upload
          - both

env:
  LOCIZE_PROJECT_ID: ${{ secrets.LOCIZE_PROJECT_ID }}
  LOCIZE_API_KEY: ${{ secrets.LOCIZE_API_KEY }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install locize-cli
        run: pnpm add -g locize-cli

      - name: Download translations from Locize
        if: github.event.inputs.direction != 'upload'
        working-directory: packages/i18n
        run: |
          locize download \
            --project-id $LOCIZE_PROJECT_ID \
            --api-key $LOCIZE_API_KEY \
            --path ./locales \
            --clean true \
            --namespace translation

      - name: Upload translations to Locize
        if: github.event.inputs.direction == 'upload' || github.event.inputs.direction == 'both'
        working-directory: packages/i18n
        run: |
          locize upload \
            --project-id $LOCIZE_PROJECT_ID \
            --api-key $LOCIZE_API_KEY \
            --path ./locales \
            --namespace translation

      - name: Commit and push changes
        if: github.event.inputs.direction != 'upload'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add packages/i18n/locales/
          git diff --staged --quiet || git commit -m "chore(i18n): sync translations from Locize [skip ci]"
          git push
